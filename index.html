<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡πÅ‡∏Å‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå‡∏•‡∏≤‡∏ß</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Prompt', sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Header Stats */
        .header-stats { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 15px 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; gap: 25px; align-items: center; }
        .stat-box { text-align: center; padding: 0 15px; }
        .stat-box:not(:last-child) { border-right: 1px solid rgba(255,255,255,0.2); }
        .stat-number { font-size: 32px; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-number.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); -webkit-background-clip: text; }
        .stat-number.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); -webkit-background-clip: text; }
        .stat-number.gray { background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%); -webkit-background-clip: text; }
        .stat-label { font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 3px; }
        
        /* Legend - Redesigned */
        .legend {
            position: absolute;
            bottom: 30px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            min-width: 280px;
        }
        .legend h4 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .legend-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .legend-section-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 13px;
            color: #333;
        }
        .legend-marker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            font-weight: 700;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .legend-marker.green { background: #11998e; }
        .legend-marker.orange { background: #f5576c; }
        .legend-marker.gray { background: #95a5a6; }
        .legend-text {
            flex: 1;
        }
        .legend-text strong {
            display: block;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .legend-text span {
            font-size: 11px;
            color: #888;
        }
        
        /* Signal Legend */
        .signal-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }
        .signal-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 12px;
        }
        .signal-provider {
            font-weight: 600;
            width: 50px;
        }
        .signal-icons {
            display: flex;
            gap: 15px;
        }
        .signal-icons span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .sig-ok { color: #11998e; }
        .sig-no { color: #f5576c; }
        
        /* Buttons */
        .refresh-btn { position: absolute; top: 20px; right: 20px; z-index: 1000; background: white; border: none; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; font-family: 'Prompt', sans-serif; font-size: 14px; transition: all 0.3s; }
        .refresh-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        
        .distance-btn { 
            position: absolute; 
            top: 20px; 
            right: 140px; 
            z-index: 1000; 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); 
            color: white;
            border: none; 
            padding: 12px 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(17,153,142,0.4); 
            cursor: pointer; 
            font-family: 'Prompt', sans-serif; 
            font-size: 14px; 
            transition: all 0.3s; 
        }
        .distance-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(17,153,142,0.5); }
        .distance-btn.active { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); box-shadow: 0 4px 15px rgba(235,51,73,0.4); }
        .edit-btn { position: absolute; top: 20px; left: 20px; z-index: 1000; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(102,126,234,0.4); font-family: 'Prompt', sans-serif; font-size: 14px; text-decoration: none; transition: all 0.3s; }
        .edit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(102,126,234,0.5); }
        
        /* Info Window */
        .info-window { min-width: 300px; font-family: 'Prompt', sans-serif; }
        .info-header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 15px 20px; color: white; border-radius: 12px 12px 0 0; }
        .info-title { font-size: 16px; font-weight: 600; margin-bottom: 5px; }
        .info-subtitle { font-size: 12px; opacity: 0.7; }
        .info-body { padding: 15px 20px; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        .info-label { color: #888; }
        .info-value { font-weight: 500; color: #333; }
        .signal-grid { display: flex; gap: 8px; margin-top: 15px; }
        .signal-card { flex: 1; text-align: center; padding: 12px 8px; border-radius: 12px; background: #f8f9fa; }
        .signal-card.ok { background: #d4edda; }
        .signal-card.no { background: #f8d7da; }
        .signal-card-provider { font-size: 12px; font-weight: 600; margin-bottom: 5px; }
        .signal-status { font-size: 18px; }
        .btn-maps { display: block; text-align: center; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 10px; margin-top: 15px; font-size: 13px; }
        
        /* Loading */
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; gap: 20px; }
        .loading.hidden { display: none; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        .loading-text { color: rgba(255,255,255,0.7); font-size: 14px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .error-box { background: #fff; padding: 30px; border-radius: 16px; text-align: center; max-width: 400px; }
        .error-box h3 { color: #eb3349; margin-bottom: 10px; }
        .error-box p { color: #666; font-size: 14px; margin-bottom: 20px; }
        .error-box button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-family: 'Prompt', sans-serif; font-size: 14px; cursor: pointer; }
        
        /* Custom Marker Label */
        .marker-label {
            background: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            white-space: nowrap;
            border: 2px solid;
        }
        .marker-label.green { border-color: #11998e; color: #11998e; }
        .marker-label.orange { border-color: #f5576c; color: #f5576c; }
        .marker-label.gray { border-color: #95a5a6; color: #95a5a6; }
        
        .legend h4 small { display: none; }
        
        @media (max-width: 768px) { 
            /* Header Stats ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            .header-stats { 
                padding: 8px 10px; 
                gap: 8px; 
                width: 95%; 
                top: 10px;
                border-radius: 12px;
            } 
            .stat-box { padding: 0 8px; }
            .stat-number { font-size: 18px; } 
            .stat-label { font-size: 9px; line-height: 1.2; }
            
            /* Legend ‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
            .legend {
                bottom: 20px;
                left: 10px;
                right: auto;
                top: auto;
                width: auto;
                max-width: 200px;
                max-height: 45px;
                overflow: hidden;
                transition: max-height 0.3s ease-out;
                min-width: 0;
                padding: 10px 12px;
                cursor: pointer;
            }
            .legend.active {
                max-height: 350px;
                max-width: 280px;
                overflow-y: auto;
            }
            .legend.active h4::after {
                content: ' ‚ñ¥';
            }
            .legend h4 { font-size: 13px; margin-bottom: 0; }
            .legend.active h4 { margin-bottom: 12px; }
            .legend h4 small { display: inline; }
            .legend h4::after {
                content: ' ‚ñæ';
            }
            .legend-section { margin-bottom: 8px; padding-bottom: 8px; }
            .legend-section-title { font-size: 10px; margin-bottom: 6px; }
            .legend-item { margin: 5px 0; }
            .legend-marker { width: 22px; height: 22px; font-size: 10px; margin-right: 8px; border-width: 2px; }
            .legend-text strong { font-size: 11px; }
            .legend-text span { font-size: 9px; }
            .signal-box { padding: 6px; margin-top: 6px; }
            .signal-row { font-size: 10px; padding: 3px 0; }
            .signal-provider { width: 40px; }
            
            /* ‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
            .edit-btn { 
                left: auto;
                right: 70px; 
                bottom: 25px; 
                top: auto;
                width: 45px;
                height: 45px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                padding: 0;
            }
            .edit-btn span { display: none; }
            .refresh-btn { 
                right: 15px; 
                bottom: 25px; 
                top: auto;
                width: 45px;
                height: 45px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                padding: 0;
            }
            .refresh-btn span { display: none; }
            
            /* ‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞ */
            .distance-btn {
                right: 125px;
                bottom: 25px;
                top: auto;
                width: 45px;
                height: 45px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                padding: 0;
            }
            .distance-btn span { display: none; }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet...</div>
    </div>
    
    <div id="map"></div>
    
    <div class="header-stats">
        <div class="stat-box">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
        <div class="stat-box">
            <div class="stat-number green" id="surveyedOkCount">0</div>
            <div class="stat-label">‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì<br>‡πÉ‡∏ä‡πâ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏î‡πâ</div>
        </div>
        <div class="stat-box">
            <div class="stat-number orange" id="surveyedNoCount">0</div>
            <div class="stat-label">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì<br>‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤‡∏¢</div>
        </div>
        <div class="stat-box">
            <div class="stat-number gray" id="pendingCount">0</div>
            <div class="stat-label">‡∏£‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à</div>
        </div>
    </div>
    
    <a href="https://docs.google.com/spreadsheets/d/1oWbmuEa2Fhn2u03q7X_jFGpXdm1HrtOoHe7WYL8eDfg/edit" target="_blank" class="edit-btn">üìù<span> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span></a>
    
    <button class="refresh-btn" onclick="loadData()">üîÑ<span> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span></button>
    
    <button class="distance-btn" onclick="toggleDistanceLines()">üìè<span> ‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞</span></button>
    
    <div class="legend" onclick="this.classList.toggle('active')">
        <h4>üìç ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà <small style="font-weight:normal;font-size:11px;opacity:0.6;">(‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π)</small></h4>
        
        <div class="legend-section">
            <div class="legend-section-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏™‡∏µ</div>
            
            <div class="legend-item">
                <div class="legend-marker green">‚úì</div>
                <div class="legend-text">
                    <strong>‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß - ‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì</strong>
                    <span>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏î‡πâ</span>
                </div>
            </div>
            
            <div class="legend-item">
                <div class="legend-marker orange">‚úó</div>
                <div class="legend-text">
                    <strong>‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì</strong>
                    <span>‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤‡∏¢‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ</span>
                </div>
            </div>
            
            <div class="legend-item">
                <div class="legend-marker gray">?</div>
                <div class="legend-text">
                    <strong>‡∏£‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à</strong>
                    <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì</span>
                </div>
            </div>
        </div>
        
        <div class="legend-section">
            <div class="legend-section-title">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π)</div>
            <div class="signal-box">
                <div class="signal-row">
                    <span class="signal-provider" style="color:#00a651;">AIS</span>
                    <div class="signal-icons">
                        <span class="sig-ok">‚úì ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</span>
                        <span class="sig-no">‚úó ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</span>
                    </div>
                </div>
                <div class="signal-row">
                    <span class="signal-provider" style="color:#00b2e3;">DTAC</span>
                    <div class="signal-icons">
                        <span class="sig-ok">‚úì ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</span>
                        <span class="sig-no">‚úó ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</span>
                    </div>
                </div>
                <div class="signal-row">
                    <span class="signal-provider" style="color:#eb2227;">TRUE</span>
                    <div class="signal-icons">
                        <span class="sig-ok">‚úì ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</span>
                        <span class="sig-no">‚úó ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1oWbmuEa2Fhn2u03q7X_jFGpXdm1HrtOoHe7WYL8eDfg';
        let map, markers = [], infoWindow, locationsData = [];
        let distanceLines = [], distanceLabels = [];
        let showingDistances = false;
        
        // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡πÇ‡∏Ç‡∏á (‡∏ä‡∏≤‡∏¢‡πÅ‡∏î‡∏ô‡πÑ‡∏ó‡∏¢-‡∏•‡∏≤‡∏ß) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
        const MEKONG_BORDER = [
            // ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢ - ‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥
            { lat: 20.35, lng: 100.08 },
            { lat: 20.32, lng: 100.09 },
            { lat: 20.28, lng: 100.10 },
            { lat: 20.26, lng: 100.15 },
            { lat: 20.25, lng: 100.20 },
            { lat: 20.24, lng: 100.25 },
            { lat: 20.23, lng: 100.30 },
            { lat: 20.24, lng: 100.35 },
            { lat: 20.26, lng: 100.40 },
            // ‡∏ï‡πà‡∏≠‡∏•‡∏á‡πÑ‡∏õ
            { lat: 19.90, lng: 100.50 },
            { lat: 19.50, lng: 100.80 },
            { lat: 19.00, lng: 101.10 },
            { lat: 18.50, lng: 101.30 },
            // ‡πÄ‡∏•‡∏¢
            { lat: 17.89, lng: 101.46 },
            { lat: 17.80, lng: 101.42 },
            { lat: 17.73, lng: 101.39 },
            { lat: 17.65, lng: 101.50 },
            { lat: 17.60, lng: 101.70 },
            { lat: 17.65, lng: 101.90 },
            { lat: 17.70, lng: 102.10 },
            { lat: 17.75, lng: 102.30 },
            { lat: 17.80, lng: 102.50 },
            // ‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢
            { lat: 17.88, lng: 102.74 },
            { lat: 17.90, lng: 102.90 },
            { lat: 17.96, lng: 103.10 },
            { lat: 18.00, lng: 103.30 },
            { lat: 18.10, lng: 103.50 },
            // ‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨
            { lat: 18.36, lng: 103.65 },
            { lat: 18.30, lng: 103.80 },
            { lat: 18.20, lng: 104.00 },
            { lat: 18.10, lng: 104.28 },
            // ‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°
            { lat: 17.90, lng: 104.37 },
            { lat: 17.70, lng: 104.50 },
            { lat: 17.50, lng: 104.65 },
            { lat: 17.41, lng: 104.78 },
            { lat: 17.20, lng: 104.80 },
            { lat: 17.00, lng: 104.78 },
            { lat: 16.80, lng: 104.75 },
            // ‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£
            { lat: 16.54, lng: 104.72 },
            { lat: 16.50, lng: 104.80 },
            { lat: 16.49, lng: 104.97 },
            { lat: 16.40, lng: 105.05 },
            // ‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ
            { lat: 16.16, lng: 105.11 },
            { lat: 16.00, lng: 105.20 },
            { lat: 15.80, lng: 105.35 },
            { lat: 15.63, lng: 105.52 },
            { lat: 15.40, lng: 105.50 },
            { lat: 15.14, lng: 105.47 },
            { lat: 15.00, lng: 105.60 },
            { lat: 14.94, lng: 105.93 },
        ];
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á Haversine
        function haversineDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡πÄ‡∏™‡πâ‡∏ô (line segment)
        function nearestPointOnSegment(px, py, ax, ay, bx, by) {
            const dx = bx - ax;
            const dy = by - ay;
            const t = Math.max(0, Math.min(1, ((px - ax) * dx + (py - ay) * dy) / (dx * dx + dy * dy)));
            return {
                lat: ay + t * dy,
                lng: ax + t * dx
            };
        }
        
        // ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡πÇ‡∏Ç‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        function findNearestBorderPoint(lat, lng) {
            let nearestPoint = null;
            let minDistance = Infinity;
            
            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏∏‡∏Å segment ‡∏Ç‡∏≠‡∏á‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡πÇ‡∏Ç‡∏á
            for (let i = 0; i < MEKONG_BORDER.length - 1; i++) {
                const a = MEKONG_BORDER[i];
                const b = MEKONG_BORDER[i + 1];
                
                // ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ö‡∏ô segment ‡∏ô‡∏µ‡πâ
                const nearest = nearestPointOnSegment(lng, lat, a.lng, a.lat, b.lng, b.lat);
                const dist = haversineDistance(lat, lng, nearest.lat, nearest.lng);
                
                if (dist < minDistance) {
                    minDistance = dist;
                    nearestPoint = nearest;
                }
            }
            
            return { point: nearestPoint, distance: minDistance };
        }
        
        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
        function toggleDistanceLines() {
            const btn = document.querySelector('.distance-btn');
            
            if (showingDistances) {
                clearDistanceLines();
                btn.classList.remove('active');
                btn.innerHTML = 'üìè<span> ‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞</span>';
            } else {
                drawDistanceLines();
                btn.classList.add('active');
                btn.innerHTML = '‚ùå<span> ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏¢‡∏∞</span>';
            }
            
            showingDistances = !showingDistances;
        }
        
        // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
        function drawDistanceLines() {
            clearDistanceLines();
            
            locationsData.forEach(loc => {
                const nearest = findNearestBorderPoint(loc.lat, loc.lng);
                
                // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô
                const line = new google.maps.Polyline({
                    path: [
                        { lat: loc.lat, lng: loc.lng },
                        { lat: nearest.point.lat, lng: nearest.point.lng }
                    ],
                    geodesic: true,
                    strokeColor: '#e74c3c',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    map: map
                });
                distanceLines.push(line);
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö label
                const midLat = (loc.lat + nearest.point.lat) / 2;
                const midLng = (loc.lng + nearest.point.lng) / 2;
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á label ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
                const labelMarker = new google.maps.Marker({
                    position: { lat: midLat, lng: midLng },
                    map: map,
                    icon: {
                        url: 'data:image/svg+xml,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"></svg>
                        `),
                    },
                    label: {
                        text: `${nearest.distance.toFixed(1)} km`,
                        color: '#c0392b',
                        fontSize: '11px',
                        fontWeight: 'bold',
                        fontFamily: 'Prompt, sans-serif'
                    }
                });
                distanceLabels.push(labelMarker);
            });
            
            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏≤‡∏¢‡πÅ‡∏î‡∏ô (‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡πÇ‡∏Ç‡∏á)
            const borderLine = new google.maps.Polyline({
                path: MEKONG_BORDER,
                geodesic: true,
                strokeColor: '#3498db',
                strokeOpacity: 0.6,
                strokeWeight: 4,
                map: map
            });
            distanceLines.push(borderLine);
        }
        
        // ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
        function clearDistanceLines() {
            distanceLines.forEach(line => line.setMap(null));
            distanceLabels.forEach(label => label.setMap(null));
            distanceLines = [];
            distanceLabels = [];
        }
        
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 17.5, lng: 104 },
                zoom: 6,
                styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }],
                mapTypeControl: true,
                fullscreenControl: true,
                streetViewControl: false
            });
            infoWindow = new google.maps.InfoWindow();
            loadData();
        }
        
        function getCellValue(row, index) {
            if (row.c && row.c[index] && row.c[index].v !== null && row.c[index].v !== undefined) {
                return row.c[index].v;
            }
            return '';
        }
        
        async function loadData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loadingText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet...';
            
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
                const response = await fetch(url);
                const text = await response.text();
                
                const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/);
                
                if (!match || !match[1]) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
                
                const json = JSON.parse(match[1]);
                
                locationsData = [];
                json.table.rows.forEach((row, idx) => {
                    const lat = parseFloat(getCellValue(row, 2));
                    const lng = parseFloat(getCellValue(row, 3));
                    
                    if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        locationsData.push({
                            id: getCellValue(row, 0) || idx + 1,
                            name: getCellValue(row, 1) || '',
                            lat: lat,
                            lng: lng,
                            freq: getCellValue(row, 4) || 0,
                            province: getCellValue(row, 5) || '',
                            area: getCellValue(row, 6) || '',
                            team: getCellValue(row, 7) || '',
                            gmaps: getCellValue(row, 8) || '',
                            status: getCellValue(row, 9) || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à',
                            date: getCellValue(row, 10) || '',
                            ais: getCellValue(row, 13) || '',
                            dtac: getCellValue(row, 14) || '',
                            true_h: getCellValue(row, 15) || '',
                            note: getCellValue(row, 18) || ''
                        });
                    }
                });
                
                console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', locationsData.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                
                renderMarkers();
                updateStats();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('loadingText').innerHTML = `
                    <div class="error-box">
                        <h3>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</h3>
                        <p>Error: ${error.message}</p>
                        <button onclick="loadData()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                `;
                return;
            }
            
            document.getElementById('loading').classList.add('hidden');
        }
        
        function getMarkerColor(loc) {
            if (loc.status === '‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß') {
                return loc.ais === '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' ? 'green' : 'orange';
            }
            return 'gray';
        }
        
        function getMarkerIcon(loc) {
            const color = getMarkerColor(loc);
            const colors = {
                green: '#11998e',
                orange: '#f5576c',
                gray: '#95a5a6'
            };
            const symbols = {
                green: '‚úì',
                orange: '‚úó',
                gray: '?'
            };
            
            return {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: colors[color],
                fillOpacity: 1,
                strokeColor: '#fff',
                strokeWeight: 3,
                scale: 14
            };
        }
        
        function createInfo(loc) {
            const gc = v => v === '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' ? 'ok' : (v === '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ' ? 'no' : '');
            const gi = v => v === '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' ? '‚úì' : (v === '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ' ? '‚úó' : '-');
            const color = getMarkerColor(loc);
            const statusText = {
                green: '‚úÖ ‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì - ‡πÉ‡∏ä‡πâ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏î‡πâ',
                orange: '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì - ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤‡∏¢',
                gray: '‚è≥ ‡∏£‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à - ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
            };
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏≤‡∏¢‡πÅ‡∏î‡∏ô
            const nearest = findNearestBorderPoint(loc.lat, loc.lng);
            const distanceText = `${nearest.distance.toFixed(1)} km`;
            
            return `
                <div class="info-window">
                    <div class="info-header">
                        <div class="info-title">${loc.name}</div>
                        <div class="info-subtitle">#${loc.id} ‚Ä¢ ${loc.province || '-'}</div>
                    </div>
                    <div class="info-body">
                        <div class="info-row">
                            <span class="info-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                            <span class="info-value">${statusText[color]}</span>
                        </div>
                        <div class="info-row" style="background:#fff3cd;margin:0 -20px;padding:8px 20px;">
                            <span class="info-label">üìè ‡∏´‡πà‡∏≤‡∏á‡∏ä‡∏≤‡∏¢‡πÅ‡∏î‡∏ô</span>
                            <span class="info-value" style="color:#856404;">${distanceText}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ä‡∏õ.</span>
                            <span class="info-value">${loc.area || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•</span>
                            <span class="info-value">${loc.team || '-'}</span>
                        </div>
                        ${loc.status === '‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' ? `
                        <div class="signal-grid">
                            <div class="signal-card ${gc(loc.ais)}">
                                <div class="signal-card-provider" style="color:#00a651;">AIS</div>
                                <div class="signal-status">${gi(loc.ais)}</div>
                            </div>
                            <div class="signal-card ${gc(loc.dtac)}">
                                <div class="signal-card-provider" style="color:#00b2e3;">DTAC</div>
                                <div class="signal-status">${gi(loc.dtac)}</div>
                            </div>
                            <div class="signal-card ${gc(loc.true_h)}">
                                <div class="signal-card-provider" style="color:#eb2227;">TRUE</div>
                                <div class="signal-status">${gi(loc.true_h)}</div>
                            </div>
                        </div>
                        ` : ''}
                        ${loc.note ? `<p style="margin-top:15px;padding:10px;background:#f8f9fa;border-radius:8px;font-size:12px;color:#666;">üìù ${loc.note}</p>` : ''}
                        ${loc.gmaps ? `<a href="${loc.gmaps}" target="_blank" class="btn-maps">üìç ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps</a>` : ''}
                    </div>
                </div>
            `;
        }
        
        function renderMarkers() {
            markers.forEach(m => {
                m.marker.setMap(null);
                if (m.label) m.label.setMap(null);
            });
            markers = [];
            
            const bounds = new google.maps.LatLngBounds();
            
            locationsData.forEach(loc => {
                const position = { lat: loc.lat, lng: loc.lng };
                bounds.extend(position);
                
                const color = getMarkerColor(loc);
                const symbols = { green: '‚úì', orange: '‚úó', gray: '?' };
                
                // Main marker
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: getMarkerIcon(loc),
                    title: loc.name,
                    label: {
                        text: symbols[color],
                        color: 'white',
                        fontSize: '14px',
                        fontWeight: 'bold'
                    }
                });
                
                // Label with name
                const labelDiv = document.createElement('div');
                const shortName = loc.name.split(' - ')[0] || loc.name.substring(0, 10);
                
                const labelMarker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: {
                        url: 'data:image/svg+xml,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"></svg>
                        `),
                        anchor: new google.maps.Point(0, -20)
                    },
                    label: {
                        text: shortName,
                        color: color === 'green' ? '#11998e' : (color === 'orange' ? '#f5576c' : '#95a5a6'),
                        fontSize: '11px',
                        fontWeight: '600',
                        fontFamily: 'Prompt, sans-serif'
                    }
                });
                
                marker.addListener('click', () => {
                    infoWindow.setContent(createInfo(loc));
                    infoWindow.open(map, marker);
                });
                
                markers.push({ marker, label: labelMarker });
            });
            
            if (markers.length > 0) {
                map.fitBounds(bounds);
            }
        }
        
        function updateStats() {
            const total = locationsData.length;
            const surveyedOk = locationsData.filter(l => l.status === '‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' && l.ais === '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ').length;
            const surveyedNo = locationsData.filter(l => l.status === '‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß' && l.ais !== '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ').length;
            const pending = locationsData.filter(l => l.status !== '‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß').length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('surveyedOkCount').textContent = surveyedOk;
            document.getElementById('surveyedNoCount').textContent = surveyedNo;
            document.getElementById('pendingCount').textContent = pending;
        }
        
        window.initMap = initMap;
    </script>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtMkrEmWVIp6IW6vkZ9A-7vjQKc8njTOA&callback=initMap"></script>
</body>
</html>
